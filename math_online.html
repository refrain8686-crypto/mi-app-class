```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathMaster Online Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- LIBRERÍAS DE FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        
        // ==================================================================
        // 1. PEGA AQUÍ TUS CLAVES DE FIREBASE (Copia y pega del proyecto anterior)
        // ==================================================================
        const firebaseConfig = {
  apiKey: "AIzaSyCB76gVdcOJIss5qVG6ndZEG4Yqr-dTsk0",
  authDomain: "clasesmatematicasefrain.firebaseapp.com",
  databaseURL: "https://clasesmatematicasefrain-default-rtdb.firebaseio.com",
  projectId: "clasesmatematicasefrain",
  storageBucket: "clasesmatematicasefrain.firebasestorage.app",
  messagingSenderId: "700937568366",
  appId: "1:700937568366:web:1271ee6e8b57fe1196a67f"
        };
        // ==================================================================

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db;
        window.fbRef = ref;
        window.fbSet = set;
        window.fbOnValue = onValue;
        window.fbPush = push;
        window.fbRemove = remove;
        window.appLoaded = true;
    </script>

    <style>
        .animate-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONOS ---
        const Icon = ({ d, size = 20, className = "" }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>;
        const Icons = {
            User: (p) => <Icon {...p} d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />,
            Play: (p) => <Icon {...p} d="M5 3l14 9-14 9V3z" />,
            Edit: (p) => <Icon {...p} d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />,
            Trash: (p) => <Icon {...p} d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
            Wifi: (p) => <Icon {...p} d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01" />,
            Image: (p) => <Icon {...p} d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM11 14l3 3l7-7M11 14l-4 4L3 14" />,
            X: (p) => <Icon {...p} d="M18 6L6 18M6 6l12 12" />
        };

        // --- FIREBASE LOGIC ---
        const useCloud = () => {
            const [status, setStatus] = useState('loading');
            useEffect(() => {
                const check = setInterval(() => { if (window.appLoaded) { setStatus('ready'); clearInterval(check); } }, 100);
            }, []);
            const saveQuiz = (quiz) => window.fbSet(window.fbRef(window.db, 'quizzes/' + quiz.id), quiz);
            const deleteQuiz = (id) => window.fbRemove(window.fbRef(window.db, 'quizzes/' + id));
            const activateSession = (code, quizId) => window.fbSet(window.fbRef(window.db, 'sessions/' + code), { activeQuizId: quizId, status: 'active', timestamp: Date.now() });
            const submitScore = (code, name, score, total) => window.fbPush(window.fbRef(window.db, `results/${code}`), { name, score, total, timestamp: Date.now() });
            return { status, saveQuiz, deleteQuiz, activateSession, submitScore };
        };

        // --- COMPONENTES ---
        const MathKeypad = ({ onInsert }) => (
            <div className="flex flex-wrap gap-2 mb-3 p-2 bg-slate-100 rounded border">
                {['x²','x³','√','π','∞','÷','×','∫','∑'].map(s => <button key={s} onClick={()=>onInsert(s.replace('x',''))} className="bg-white px-3 py-1 rounded shadow text-indigo-700 font-bold hover:bg-indigo-50">{s}</button>)}
            </div>
        );

        const Editor = ({ quiz, onSave, onCancel }) => {
            const [localQuiz, setLocalQuiz] = useState(quiz);
            const [tempQ, setTempQ] = useState({ text: '', imageUrl: null, points: 1, options: ['',''], optionImages:[null,null], correct: 0 });
            const [isEditing, setIsEditing] = useState(false);
            const [editIdx, setEditIdx] = useState(null);

            const handleSaveQ = () => {
                if(!tempQ.text && !tempQ.imageUrl) return alert("Escribe texto o sube imagen");
                const newQs = [...(localQuiz.questions || [])];
                if (editIdx !== null) newQs[editIdx] = tempQ;
                else newQs.push(tempQ);
                setLocalQuiz({...localQuiz, questions: newQs});
                resetForm();
            };

            // --- AQUÍ ESTÁ LA CORRECCIÓN IMPORTANTE PARA EDITAR ---
            const handleEditQ = (q, index) => {
                // Rellenamos datos faltantes por si es una pregunta antigua sin imágenes
                setTempQ({
                    text: q.text || '',
                    imageUrl: q.imageUrl || null,
                    points: q.points || 1,
                    options: q.options || ['', ''],
                    optionImages: q.optionImages || new Array(q.options ? q.options.length : 2).fill(null),
                    correct: q.correct || 0
                });
                setEditIdx(index);
                setIsEditing(true);
            };
            // -----------------------------------------------------

            const handleDeleteQ = (index) => {
                if(confirm("¿Eliminar esta pregunta?")) {
                    const newQs = localQuiz.questions.filter((_, i) => i !== index);
                    setLocalQuiz({...localQuiz, questions: newQs});
                }
            };

            const resetForm = () => {
                setIsEditing(false);
                setEditIdx(null);
                setTempQ({ text: '', imageUrl: null, points: 1, options: ['',''], optionImages:[null,null], correct: 0 });
            };

            const handleImage = (e, cb) => {
                const f = e.target.files[0];
                if(f){ const r = new FileReader(); r.onload=()=>cb(r.result); r.readAsDataURL(f); }
            };

            return (
                <div className="min-h-screen bg-white p-4 animate-in">
                    <div className="max-w-2xl mx-auto">
                        <div className="flex justify-between items-center mb-4 bg-indigo-50 p-4 rounded-lg">
                            <button onClick={onCancel} className="text-gray-500 hover:text-gray-800">Cancelar</button>
                            <h2 className="font-bold text-xl text-indigo-900">Editor de Examen</h2>
                            <button onClick={()=>onSave(localQuiz)} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-green-700">Guardar Todo</button>
                        </div>
                        
                        <input className="w-full text-2xl font-bold border-b mb-6 outline-none py-2" placeholder="Título del Examen" value={localQuiz.title} onChange={e=>setLocalQuiz({...localQuiz, title: e.target.value})} />
                        
                        {isEditing ? (
                            <div className="border-2 border-indigo-100 p-6 rounded-xl shadow-lg bg-white">
                                <div className="flex justify-between mb-4">
                                    <h3 className="font-bold text-gray-700">{editIdx !== null ? 'Editar Pregunta' : 'Nueva Pregunta'}</h3>
                                    <div className="flex items-center gap-2">
                                        <span className="text-sm font-bold">Puntos:</span>
                                        <input type="number" className="border w-16 text-center p-1 rounded" value={tempQ.points} onChange={e=>setTempQ({...tempQ, points: e.target.value})} />
                                    </div>
                                </div>

                                <MathKeypad onInsert={s => setTempQ({...tempQ, text: tempQ.text + s})} />
                                
                                <div className="flex gap-4 mb-4">
                                    <textarea className="w-full border p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" rows="3" placeholder="Escribe la pregunta..." value={tempQ.text} onChange={e=>setTempQ({...tempQ, text: e.target.value})} />
                                    <div className="w-24 shrink-0">
                                        <label className="border-2 border-dashed w-full h-full flex flex-col items-center justify-center cursor-pointer rounded-lg hover:bg-gray-50">
                                            {tempQ.imageUrl ? <img src={tempQ.imageUrl} className="h-full w-full object-cover rounded-lg"/> : <div className="text-center text-xs text-gray-400"><Icons.Image size={24}/><br/>Imagen</div>}
                                            <input type="file" className="hidden" onChange={e=>handleImage(e, d=>setTempQ({...tempQ, imageUrl: d}))} />
                                        </label>
                                        {tempQ.imageUrl && <button onClick={()=>setTempQ({...tempQ, imageUrl: null})} className="text-xs text-red-500 w-full text-center mt-1">Borrar</button>}
                                    </div>
                                </div>

                                <div className="space-y-2 mb-4">
                                    {tempQ.options.map((o, i) => (
                                        <div key={i} className="flex items-center gap-3 bg-gray-50 p-2 rounded-lg border">
                                            <input type="radio" checked={tempQ.correct === i} onChange={()=>setTempQ({...tempQ, correct: i})} className="w-5 h-5 accent-green-600" />
                                            <div className="flex-1">
                                                <input className="bg-transparent border-b w-full outline-none text-sm pb-1" value={o} onChange={e=>{
                                                    const ops = [...tempQ.options]; ops[i] = e.target.value; setTempQ({...tempQ, options: ops});
                                                }} placeholder={`Opción ${i+1}`} />
                                            </div>
                                            <label className="cursor-pointer text-gray-400 hover:text-blue-500 relative">
                                                <Icons.Image size={20} className={tempQ.optionImages[i] ? "text-green-500" : ""} />
                                                <input type="file" className="hidden" onChange={e=>handleImage(e, d=>{
                                                    const imgs = [...tempQ.optionImages]; imgs[i]=d; setTempQ({...tempQ, optionImages: imgs});
                                                })} />
                                            </label>
                                            {tempQ.options.length > 2 && (
                                                <button onClick={()=>{
                                                    const ops = tempQ.options.filter((_,x)=>x!==i);
                                                    const imgs = tempQ.optionImages.filter((_,x)=>x!==i);
                                                    setTempQ({...tempQ, options: ops, optionImages: imgs, correct: 0});
                                                }} className="text-red-400 hover:text-red-600"><Icons.X size={18}/></button>
                                            )}
                                        </div>
                                    ))}
                                    <button onClick={()=>setTempQ({...tempQ, options:[...tempQ.options, ''], optionImages:[...tempQ.optionImages, null]})} className="text-indigo-600 text-sm font-bold hover:underline">+ Añadir Opción</button>
                                </div>

                                <div className="flex gap-2">
                                    <button onClick={handleSaveQ} className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold w-full shadow hover:bg-indigo-700">
                                        {editIdx !== null ? 'Actualizar Pregunta' : 'Añadir Pregunta'}
                                    </button>
                                    <button onClick={resetForm} className="bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-bold hover:bg-gray-300">Cancelar</button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {(!localQuiz.questions || localQuiz.questions.length === 0) && <p className="text-center text-gray-400 py-8 border-2 border-dashed rounded-lg">No hay preguntas. ¡Agrega una!</p>}
                                
                                {(localQuiz.questions || []).map((q, i) => (
                                    <div key={i} className="p-4 bg-white border rounded-xl shadow-sm flex justify-between items-center hover:shadow-md transition">
                                        <div className="flex items-center gap-3 overflow-hidden">
                                            <span className="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs font-bold">#{i+1}</span>
                                            <div className="flex flex-col">
                                                <span className="font-medium text-gray-800 truncate max-w-xs">{q.text || "(Imagen)"}</span>
                                                <span className="text-xs text-gray-500">{q.points} Puntos</span>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={()=>handleEditQ(q, i)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Editar"><Icons.Edit size={20} /></button>
                                            <button onClick={()=>handleDeleteQ(i)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition" title="Eliminar"><Icons.Trash size={20} /></button>
                                        </div>
                                    </div>
                                ))}
                                
                                <button onClick={()=>{resetForm(); setIsEditing(true);}} className="w-full py-4 border-2 border-dashed border-indigo-300 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition mt-6 flex items-center justify-center gap-2">
                                    <span className="text-2xl">+</span> Agregar Nueva Pregunta
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- LOBBY & DASHBOARD ---
        const LiveDashboard = ({ sessionCode, quiz, onExit }) => {
            const [students, setStudents] = useState([]);
            useEffect(() => {
                const unsub = window.fbOnValue(window.fbRef(window.db, `results/${sessionCode}`), (snap) => {
                    setStudents(snap.val() ? Object.values(snap.val()) : []);
                });
                return () => unsub();
            }, [sessionCode]);

            return (
                <div className="min-h-screen bg-slate-900 text-white p-6 animate-in">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-8 border-b border-slate-700 pb-4">
                            <div><h2 className="text-sm text-slate-400 uppercase">Sala en Vivo</h2><h1 className="text-4xl font-bold text-blue-400">{sessionCode}</h1></div>
                            <button onClick={onExit} className="bg-red-600 px-4 py-2 rounded font-bold">Finalizar</button>
                        </div>
                        <div className="grid md:grid-cols-2 gap-8">
                            <div className="bg-slate-800 p-6 rounded-xl">
                                <h3 className="text-xl font-bold mb-4 text-green-400">Resultados ({students.length})</h3>
                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {students.sort((a,b)=>b.score-a.score).map((s, i)=>(
                                        <div key={i} className="flex justify-between bg-slate-700 p-3 rounded border-l-4 border-blue-500">
                                            <span className="font-bold">{s.name}</span>
                                            <span>{s.score}/{s.total}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-slate-800 p-6 rounded-xl text-center">
                                <h3 className="text-xl font-bold mb-2">Examen Activo</h3>
                                <p className="text-2xl text-indigo-300 mb-4">{quiz.title}</p>
                                <div className="p-4 bg-slate-700 rounded"><p className="text-sm text-slate-300">Código para alumnos:</p><p className="text-4xl font-mono mt-2 text-yellow-400 font-bold tracking-widest">{sessionCode}</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const StudentLobby = ({ onJoin }) => {
            const [code, setCode] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const handleJoin = () => {
                if(!code || !name) return setError("Completa todo");
                window.fbOnValue(window.fbRef(window.db, `sessions/${code}`), (snap) => {
                    if (snap.exists() && snap.val().status === 'active') onJoin(code, name, snap.val().activeQuizId);
                    else setError("Código inválido o cerrado");
                }, { onlyOnce: true });
            };
            return (
                <div className="min-h-screen bg-blue-600 flex items-center justify-center p-4 animate-in">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
                        <h1 className="text-3xl font-black text-blue-900 mb-6">MathMaster</h1>
                        <input className="w-full p-4 bg-gray-100 rounded-xl mb-3 text-center text-xl uppercase font-bold" placeholder="CÓDIGO" value={code} onChange={e=>setCode(e.target.value.toUpperCase())} />
                        <input className="w-full p-4 bg-gray-100 rounded-xl mb-6 text-center font-bold" placeholder="Tu Nombre" value={name} onChange={e=>setName(e.target.value)} />
                        {error && <p className="text-red-500 mb-4 font-bold">{error}</p>}
                        <button onClick={handleJoin} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-700">Entrar a Clase</button>
                    </div>
                </div>
            );
        };

        // --- APP MAIN ---
        function App() {
            const cloud = useCloud();
            const [view, setView] = useState('home');
            const [quizzes, setQuizzes] = useState([]);
            const [activeQuizData, setActiveQuizData] = useState(null);
            const [liveCode, setLiveCode] = useState('');
            const [studentName, setStudentName] = useState('');
            const [studentQuiz, setStudentQuiz] = useState(null);
            
            useEffect(() => {
                if (cloud.status === 'ready') window.fbOnValue(window.fbRef(window.db, 'quizzes'), (s) => setQuizzes(s.val() ? Object.values(s.val()) : []));
            }, [cloud.status]);

            if (cloud.status === 'loading') return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;

            if (view === 'home') return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 flex flex-col items-center justify-center p-4 text-white animate-in">
                    <h1 className="text-5xl font-black mb-8">MathMaster Online</h1>
                    <div className="grid gap-4 w-full max-w-md">
                        <button onClick={()=>setView('lobby')} className="bg-white text-indigo-700 p-6 rounded-2xl font-bold text-xl shadow-xl hover:scale-105 transition flex items-center justify-center gap-3"><Icons.User /> Soy Estudiante</button>
                        <button onClick={()=>setView('tutor')} className="bg-indigo-900 border border-indigo-400 text-white p-6 rounded-2xl font-bold text-xl shadow-xl hover:scale-105 transition">Soy Profesor</button>
                    </div>
                </div>
            );

            if (view === 'tutor') return (
                <div className="min-h-screen bg-gray-50 p-6 animate-in">
                    <div className="max-w-4xl mx-auto">
                        <button onClick={()=>setView('home')} className="mb-6 font-bold text-gray-500">← Volver</button>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold text-gray-800">Mis Exámenes</h2>
                            <button onClick={()=>{setActiveQuizData({id:Date.now(), title:'', questions:[]}); setView('editor')}} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow">+ Crear Nuevo</button>
                        </div>
                        <div className="grid gap-4">
                            {quizzes.map(q => (
                                <div key={q.id} className="bg-white p-6 rounded-xl shadow flex justify-between items-center">
                                    <div><h3 className="font-bold text-xl">{q.title}</h3><p className="text-gray-500">{(q.questions||[]).length} preguntas</p></div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>{
                                            const code = Math.random().toString(36).substring(2, 7).toUpperCase();
                                            cloud.activateSession(code, q.id); setActiveQuizData(q); setLiveCode(code); setView('live');
                                        }} className="bg-green-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-600 flex items-center gap-2"><Icons.Wifi /> LANZAR</button>
                                        <button onClick={()=>{setActiveQuizData(q); setView('editor')}} className="bg-gray-100 text-blue-600 p-3 rounded-lg"><Icons.Edit/></button>
                                        <button onClick={()=>{if(confirm('Borrar?')) cloud.deleteQuiz(q.id)}} className="bg-red-50 text-red-500 p-3 rounded-lg"><Icons.Trash/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if (view === 'editor') return <Editor quiz={activeQuizData} onSave={(q)=>{cloud.saveQuiz(q); setView('tutor');}} onCancel={()=>setView('tutor')} />;
            if (view === 'live') return <LiveDashboard sessionCode={liveCode} quiz={activeQuizData} onExit={()=>setView('tutor')} />;
            if (view === 'lobby') return <StudentLobby onJoin={(c, n, qId) => { setLiveCode(c); setStudentName(n); window.fbOnValue(window.fbRef(window.db, `quizzes/${qId}`), s=>{setStudentQuiz(s.val()); setView('quiz')}, {onlyOnce:true}); }} />;

            if (view === 'quiz') {
                const QuizTaker = ({ quiz, onSubmit }) => {
                    const [idx, setIdx] = useState(0);
                    const [score, setScore] = useState(0);
                    const q = quiz.questions[idx];
                    const handleAns = (i) => {
                        const newScore = score + (i === q.correct ? parseInt(q.points) : 0);
                        setScore(newScore);
                        if(idx + 1 < quiz.questions.length) setIdx(idx + 1);
                        else onSubmit(newScore);
                    };
                    return (
                        <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4 animate-in">
                            <div className="max-w-2xl w-full bg-white p-6 rounded-2xl shadow-xl">
                                <div className="flex justify-between mb-4 font-bold text-gray-500"><span>{idx+1}/{quiz.questions.length}</span><span>{studentName}</span></div>
                                <div className="h-2 bg-gray-200 mb-6 rounded"><div className="h-full bg-blue-500 transition-all" style={{width: `${(idx/quiz.questions.length)*100}%`}}></div></div>
                                {q.imageUrl && <img src={q.imageUrl} className="h-48 w-full object-contain mb-4 rounded border"/>}
                                <h2 className="text-2xl font-bold mb-6">{q.text}</h2>
                                <div className="grid gap-3">
                                    {q.options.map((o, i) => (
                                        <button key={i} onClick={()=>handleAns(i)} className="text-left p-4 border-2 rounded-xl hover:bg-blue-50 hover:border-blue-500 font-medium flex items-center gap-3">
                                            <span className="bg-gray-200 w-8 h-8 flex items-center justify-center rounded-full font-bold">{String.fromCharCode(65+i)}</span>
                                            <div className="flex-1">{q.optionImages && q.optionImages[i] && <img src={q.optionImages[i]} className="h-20 rounded mb-2 border"/>}{o}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    );
                };
                return <QuizTaker quiz={studentQuiz} onSubmit={(sc)=>{
                    const total = studentQuiz.questions.reduce((a,b)=>a+(parseInt(b.points)||0),0);
                    cloud.submitScore(liveCode, studentName, sc, total);
                    alert(`Finalizado: ${sc}/${total}`); setView('home');
                }} />;
            }
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
```
