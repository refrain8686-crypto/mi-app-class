```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathMaster - Edici√≥n Efrain (Full Math)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Confeti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        
        // ==================================================================
        // 1. PEGA AQU√ç TUS CLAVES DE FIREBASE
        // ==================================================================
        const firebaseConfig = {
  apiKey: "AIzaSyCB76gVdcOJIss5qVG6ndZEG4Yqr-dTsk0",
  authDomain: "clasesmatematicasefrain.firebaseapp.com",
  databaseURL: "https://clasesmatematicasefrain-default-rtdb.firebaseio.com",
  projectId: "clasesmatematicasefrain",
  storageBucket: "clasesmatematicasefrain.firebasestorage.app",
  messagingSenderId: "700937568366",
  appId: "1:700937568366:web:1271ee6e8b57fe1196a67f"
        };
        // ==================================================================

        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            window.db = db; window.fbRef = ref; window.fbSet = set; window.fbOnValue = onValue; window.fbPush = push; window.fbRemove = remove; window.appLoaded = true;
        } catch (e) {
            console.error("Error Firebase", e);
            alert("Error de conexi√≥n. Revisa las claves.");
        }
    </script>

    <style>
        .animate-in { animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.4s ease-in-out; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .math-preview sup { font-size: 0.75em; vertical-align: super; color: #4f46e5; font-weight: bold; }
        .math-preview .fraction { display: inline-block; text-align: center; vertical-align: middle; margin: 0 4px; }
        .math-preview .fraction > span { display: block; padding: 0 2px; }
        .math-preview .fraction span.numerator { border-bottom: 2px solid currentColor; }
        .math-preview .fraction span.denominator { font-size: 0.9em; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SISTEMA DE SONIDO ROBUSTO ---
        const playSound = (type) => {
            try {
                let src;
                if(type === 'click') src = 'https://actions.google.com/sounds/v1/alarms/beep_short.ogg'; 
                else if(type === 'correct') src = 'https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg';
                else if(type === 'wrong') src = 'https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg';
                else src = 'https://upload.wikimedia.org/wikipedia/commons/5/56/Applause_2.ogg';

                const audio = new Audio(src);
                audio.volume = 0.5;
                const playPromise = audio.play();
                if (playPromise !== undefined) { playPromise.catch(error => { console.log("Audio bloqueado."); }); }
            } catch (e) { console.error(e); }
        };

        // --- ICONOS ---
        const Icon = ({ d, size = 20, className = "" }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>;
        const Icons = {
            User: (p) => <Icon {...p} d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />,
            Play: (p) => <Icon {...p} d="M5 3l14 9-14 9V3z" />,
            Edit: (p) => <Icon {...p} d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />,
            Trash: (p) => <Icon {...p} d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
            Wifi: (p) => <Icon {...p} d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01" />,
            Image: (p) => <Icon {...p} d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM11 14l3 3l7-7M11 14l-4 4L3 14" />,
            X: (p) => <Icon {...p} d="M18 6L6 18M6 6l12 12" />,
            ToggleL: (p) => <Icon {...p} d="M17 2H7a5 5 0 0 0-5 5v10a5 5 0 0 0 5 5h10a5 5 0 0 0 5-5V7a5 5 0 0 0-5-5zm-5 14H7v-4h5v4zm0-6H7V6h5v4z" />,
            Check: (p) => <Icon {...p} d="M20 6L9 17l-5-5" />,
            Home: (p) => <Icon {...p} d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
        };

        // --- FIREBASE ---
        const useCloud = () => {
            const [status, setStatus] = useState('loading');
            useEffect(() => { const check = setInterval(() => { if (window.appLoaded) { setStatus('ready'); clearInterval(check); } }, 100); }, []);
            const saveQuiz = (quiz) => { if (!window.db) return alert("Error de conexi√≥n. Verifica tus claves."); window.fbSet(window.fbRef(window.db, 'quizzes/' + quiz.id), quiz); };
            const deleteQuiz = (id) => window.fbRemove(window.fbRef(window.db, 'quizzes/' + id));
            const activateSession = (code, quizId) => window.fbSet(window.fbRef(window.db, 'sessions/' + code), { activeQuizId: quizId, status: 'active', timestamp: Date.now() });
            const submitScore = (code, name, score, total) => window.fbPush(window.fbRef(window.db, `results/${code}`), { name, score, total, timestamp: Date.now() });
            return { status, saveQuiz, deleteQuiz, activateSession, submitScore };
        };

        // --- UTILIDADES ---
        const renderMathText = (text) => {
            if (!text) return null;
            let formatted = text.replace(/\^(\d+|\([^)]+\))/g, (match, p1) => `<sup>${p1.replace(/[()]/g, '')}</sup>`);
            formatted = formatted.replace(/(\d+|[a-z])\/(\d+|[a-z])/gi, '<div class="fraction"><span class="numerator">$1</span><span class="denominator">$2</span></div>');
            return <span dangerouslySetInnerHTML={{__html: formatted}} />;
        };

        // --- COMPONENTES ---
        const MathKeypad = ({ onInsert }) => (
            <div className="flex flex-wrap gap-2 mb-3 p-2 bg-slate-100 rounded border">
                {['x¬≤','x‚Åø','¬Ω','‚àö','œÄ','‚àû','√∑','√ó','‚à´','‚â†'].map((l,i) => 
                    <button key={i} onMouseDown={(e) => { e.preventDefault(); playSound('click'); onInsert(['^2','^','1/2','‚àö','œÄ','‚àû','√∑','√ó','‚à´','‚â†'][i]); }} className="bg-white px-3 py-1 rounded shadow text-indigo-700 font-bold border border-indigo-100 hover:bg-indigo-50">{l}</button>
                )}
            </div>
        );

        const Editor = ({ quiz, onSave, onCancel }) => {
            const [localQuiz, setLocalQuiz] = useState(quiz);
            const [tempQ, setTempQ] = useState({ text: '', imageUrl: null, points: 1, type: 'multiple', options: ['',''], optionImages:[null,null], correct: 0 });
            const [isEditing, setIsEditing] = useState(false);
            const [editIdx, setEditIdx] = useState(null);
            
            // NUEVO: Estado para saber d√≥nde escribir los s√≠mbolos
            // 'question' = Enunciado, 'opt-0' = Opci√≥n 1, etc.
            const [activeField, setActiveField] = useState('question'); 

            // Funci√≥n inteligente para insertar s√≠mbolos donde est√© el foco
            const handleInsertSymbol = (symbol) => {
                if (activeField === 'question') {
                    setTempQ({ ...tempQ, text: tempQ.text + symbol });
                } else if (activeField.startsWith('opt-')) {
                    const index = parseInt(activeField.split('-')[1]);
                    const newOptions = [...tempQ.options];
                    newOptions[index] = newOptions[index] + symbol;
                    setTempQ({ ...tempQ, options: newOptions });
                }
            };

            const handleFinalSave = () => {
                playSound('click');
                if(!localQuiz.title.trim()) return alert("¬°Falta el t√≠tulo!");
                if(!localQuiz.questions || localQuiz.questions.length === 0) return alert("Agrega al menos una pregunta.");
                onSave(localQuiz);
            };

            const handleSaveQ = () => {
                playSound('click');
                if(!tempQ.text && !tempQ.imageUrl) return alert("Falta el enunciado");
                if(tempQ.type === 'boolean') tempQ.options = ['Verdadero', 'Falso'];
                const newQs = [...(localQuiz.questions || [])];
                if (editIdx !== null) newQs[editIdx] = tempQ; else newQs.push(tempQ);
                setLocalQuiz({...localQuiz, questions: newQs});
                resetForm();
            };

            const handleEditQ = (q, index) => {
                setTempQ({
                    text: q.text || '', imageUrl: q.imageUrl || null, points: q.points || 1, type: q.type || 'multiple',
                    options: q.options || (q.type==='boolean'?['Verdadero','Falso']:['','']), optionImages: q.optionImages || [null,null], correct: q.correct || 0
                });
                setEditIdx(index); setIsEditing(true);
                setActiveField('question');
            };

            const handleDeleteQ = (index) => { if(confirm("¬øEliminar?")) setLocalQuiz({...localQuiz, questions: localQuiz.questions.filter((_, i) => i !== index)}); };
            const resetForm = () => { setIsEditing(false); setEditIdx(null); setTempQ({ text: '', imageUrl: null, points: 1, type: 'multiple', options: ['',''], optionImages:[null,null], correct: 0 }); setActiveField('question'); };
            const handleImage = (e, cb) => { const f = e.target.files[0]; if(f){ const r = new FileReader(); r.onload=()=>cb(r.result); r.readAsDataURL(f); } };
            const toggleType = (t) => { playSound('click'); setTempQ({...tempQ, type: t, options: t==='boolean'?['Verdadero','Falso']:['',''], optionImages: [null,null], correct: 0}); }

            return (
                <div className="min-h-screen bg-white p-4 animate-in">
                    <div className="max-w-3xl mx-auto">
                        <div className="flex justify-between items-center mb-4 bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                            <button onClick={onCancel} className="text-gray-500 hover:text-gray-800">Cancelar</button>
                            <h2 className="font-bold text-xl text-indigo-900">Editor Pro</h2>
                            <button onClick={handleFinalSave} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-green-700">Guardar Examen</button>
                        </div>
                        <input className="w-full text-3xl font-bold border-b-2 mb-6 outline-none py-2 text-gray-800" placeholder="T√≠tulo del Examen" value={localQuiz.title} onChange={e=>setLocalQuiz({...localQuiz, title: e.target.value})} />
                        {isEditing ? (
                            <div className="border-2 border-indigo-100 p-6 rounded-xl shadow-lg bg-white pop-in">
                                <div className="flex justify-between items-center mb-4 pb-4 border-b">
                                    <div className="flex gap-2">
                                        <button onClick={()=>toggleType('multiple')} className={`px-3 py-1 rounded-full text-sm font-bold ${tempQ.type === 'multiple' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-600'}`}>Opci√≥n M√∫ltiple</button>
                                        <button onClick={()=>toggleType('boolean')} className={`px-3 py-1 rounded-full text-sm font-bold ${tempQ.type === 'boolean' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-600'}`}>V/F</button>
                                    </div>
                                    <div className="flex items-center gap-2"><span className="text-sm font-bold text-gray-500">Puntos:</span><input type="number" className="border-2 border-indigo-100 w-16 text-center p-1 rounded font-bold text-indigo-700" value={tempQ.points} onChange={e=>setTempQ({...tempQ, points: e.target.value})} /></div>
                                </div>
                                
                                {/* PASAMOS LA NUEVA FUNCI√ìN AL KEYPAD */}
                                <MathKeypad onInsert={handleInsertSymbol} />
                                
                                <div className="flex gap-4 mb-2">
                                    <div className="flex-1">
                                        <textarea 
                                            className={`w-full border p-3 rounded-lg outline-none font-medium text-lg ${activeField === 'question' ? 'ring-2 ring-indigo-500 border-indigo-500' : ''}`} 
                                            rows="3" 
                                            placeholder="Pregunta..." 
                                            value={tempQ.text} 
                                            onChange={e=>setTempQ({...tempQ, text: e.target.value})}
                                            onFocus={() => setActiveField('question')}
                                        />
                                        {tempQ.text && <div className="mt-1 p-2 bg-gray-50 rounded text-gray-600 text-sm border flex items-center gap-2"><span className="font-bold text-xs uppercase text-indigo-400">Vista Previa:</span><span className="math-preview text-lg font-serif text-black">{renderMathText(tempQ.text)}</span></div>}
                                    </div>
                                    <div className="w-24 shrink-0">
                                        <label className="border-2 border-dashed w-full h-24 flex flex-col items-center justify-center cursor-pointer rounded-lg hover:bg-gray-50">{tempQ.imageUrl ? <img src={tempQ.imageUrl} className="h-full w-full object-cover rounded-lg"/> : <div className="text-center text-xs text-gray-400"><Icons.Image size={24}/><br/>Foto</div>}<input type="file" className="hidden" onChange={e=>handleImage(e, d=>setTempQ({...tempQ, imageUrl: d}))} /></label>
                                        {tempQ.imageUrl && <button onClick={()=>setTempQ({...tempQ, imageUrl: null})} className="text-xs text-red-500 w-full text-center mt-1 hover:underline">Quitar</button>}
                                    </div>
                                </div>
                                <div className="space-y-2 mb-4 mt-6">
                                    <p className="text-xs font-bold uppercase text-gray-400 mb-2">Respuestas</p>
                                    {tempQ.options.map((o, i) => (
                                        <div key={i} className={`flex items-center gap-3 p-3 rounded-lg border-2 transition ${tempQ.correct === i ? 'border-green-500 bg-green-50' : 'border-gray-100 bg-white'}`}>
                                            <input type="radio" checked={tempQ.correct === i} onChange={()=>setTempQ({...tempQ, correct: i})} className="w-5 h-5 accent-green-600 cursor-pointer" />
                                            <div className="flex-1">
                                                {tempQ.type === 'boolean' ? (
                                                    <span className="font-bold text-gray-700">{o}</span>
                                                ) : (
                                                    <input 
                                                        className={`bg-transparent w-full outline-none text-gray-700 font-medium ${activeField === 'opt-'+i ? 'border-b-2 border-indigo-500' : ''}`}
                                                        value={o} 
                                                        onChange={e=>{const ops = [...tempQ.options]; ops[i] = e.target.value; setTempQ({...tempQ, options: ops});}} 
                                                        onFocus={() => setActiveField('opt-' + i)}
                                                        placeholder={`Opci√≥n ${i+1}`} 
                                                    />
                                                )}
                                            </div>
                                            {tempQ.type !== 'boolean' && (<><label className="cursor-pointer text-gray-400 hover:text-blue-500 relative"><Icons.Image size={20} className={tempQ.optionImages[i] ? "text-green-500" : ""} /><input type="file" className="hidden" onChange={e=>handleImage(e, d=>{const imgs = [...tempQ.optionImages]; imgs[i]=d; setTempQ({...tempQ, optionImages: imgs});})} /></label>{tempQ.options.length > 2 && <button onClick={()=>{const ops = tempQ.options.filter((_,x)=>x!==i);const imgs = tempQ.optionImages.filter((_,x)=>x!==i);setTempQ({...tempQ, options: ops, optionImages: imgs, correct: 0});}} className="text-red-300 hover:text-red-500"><Icons.X size={18}/></button>}</>)}
                                        </div>
                                    ))}
                                    {tempQ.type === 'multiple' && <button onClick={()=>setTempQ({...tempQ, options:[...tempQ.options, ''], optionImages:[...tempQ.optionImages, null]})} className="text-indigo-600 text-sm font-bold hover:underline mt-2 flex items-center gap-1">+ Opci√≥n</button>}
                                </div>
                                <div className="flex gap-2 pt-4 border-t">
                                    <button onClick={handleSaveQ} className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold w-full shadow hover:bg-indigo-700 transition">{editIdx !== null ? 'Actualizar' : 'A√±adir'}</button>
                                    <button onClick={resetForm} className="bg-gray-100 text-gray-600 px-4 py-3 rounded-lg font-bold hover:bg-gray-200">Cancelar</button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {(!localQuiz.questions || localQuiz.questions.length === 0) && <div className="text-center py-10 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200"><p className="text-gray-400">¬°Empieza a√±adiendo preguntas!</p></div>}
                                {(localQuiz.questions || []).map((q, i) => (
                                    <div key={i} className="p-4 bg-white border rounded-xl shadow-sm flex justify-between items-center hover:shadow-md transition group">
                                        <div className="flex items-center gap-4 overflow-hidden"><span className="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-lg text-sm font-bold">#{i+1}</span><div className="flex flex-col"><span className="font-medium text-gray-800 truncate max-w-md math-preview text-lg">{renderMathText(q.text) || "(Imagen)"}</span><div className="flex gap-2 mt-1"><span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">{q.points} pts</span><span className="text-xs bg-blue-50 text-blue-500 px-2 py-0.5 rounded">{q.type === 'boolean' ? 'V/F' : 'Opci√≥n M√∫ltiple'}</span></div></div></div>
                                        <div className="flex gap-2 opacity-50 group-hover:opacity-100 transition"><button onClick={()=>handleEditQ(q, i)} className="p-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg"><Icons.Edit size={18} /></button><button onClick={()=>handleDeleteQ(i)} className="p-2 bg-red-50 text-red-500 hover:bg-red-100 rounded-lg"><Icons.Trash size={18} /></button></div>
                                    </div>
                                ))}
                                <button onClick={()=>{playSound('click'); resetForm(); setIsEditing(true);}} className="w-full py-4 border-2 border-dashed border-indigo-300 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition mt-6 flex items-center justify-center gap-2 text-lg"><span>+</span> Agregar Pregunta</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LiveDashboard = ({ sessionCode, quiz, onExit }) => {
            const [students, setStudents] = useState([]);
            useEffect(() => {
                const unsub = window.fbOnValue(window.fbRef(window.db, `results/${sessionCode}`), (snap) => setStudents(snap.val() ? Object.values(snap.val()) : []));
                return () => unsub();
            }, [sessionCode]);
            return (
                <div className="min-h-screen bg-slate-900 text-white p-6 animate-in">
                    <div className="max-w-5xl mx-auto">
                        <div className="flex justify-between items-center mb-8 border-b border-slate-700 pb-4">
                            <div><h2 className="text-xs text-slate-400 uppercase tracking-wider">Clase en Vivo</h2><h1 className="text-5xl font-black text-blue-400 tracking-wide">{sessionCode}</h1></div>
                            <button onClick={onExit} className="bg-red-600 px-6 py-2 rounded-lg font-bold hover:bg-red-700 transition">Finalizar Clase</button>
                        </div>
                        <div className="grid md:grid-cols-3 gap-8">
                            <div className="md:col-span-2 bg-slate-800 p-6 rounded-2xl border border-slate-700">
                                <h3 className="text-xl font-bold mb-4 text-green-400 flex items-center gap-2"><Icons.Wifi/> Resultados ({students.length})</h3>
                                <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scroll">
                                    {students.sort((a,b)=>b.score-a.score).map((s, i)=>(
                                        <div key={i} className="flex justify-between items-center bg-slate-700 p-4 rounded-xl border-l-4 border-blue-500 shadow-sm">
                                            <div className="flex items-center gap-4"><span className="text-2xl font-black text-slate-500">#{i+1}</span><span className="font-bold text-lg">{s.name}</span></div>
                                            <div className="text-right"><span className="text-2xl font-bold text-white">{s.score}</span><span className="text-sm text-slate-400"> / {s.total} pts</span></div>
                                        </div>
                                    ))}
                                    {students.length === 0 && <p className="text-slate-500 italic text-center py-10">Esperando alumnos...</p>}
                                </div>
                            </div>
                            <div className="bg-slate-800 p-6 rounded-2xl text-center border border-slate-700 h-fit">
                                <h3 className="text-lg font-bold mb-2 text-slate-300">Examen Activo</h3>
                                <p className="text-2xl text-white font-bold mb-6">{quiz.title}</p>
                                <div className="p-6 bg-slate-900 rounded-xl border border-slate-600"><p className="text-sm text-slate-400 uppercase tracking-widest mb-2">C√≥digo de Acceso</p><p className="text-5xl font-mono text-yellow-400 font-black">{sessionCode}</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const StudentLobby = ({ onJoin }) => {
            const [code, setCode] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const handleJoin = () => {
                playSound('click');
                if(!code || !name) return setError("Completa todos los campos");
                window.fbOnValue(window.fbRef(window.db, `sessions/${code}`), (snap) => {
                    if (snap.exists() && snap.val().status === 'active') onJoin(code, name, snap.val().activeQuizId);
                    else setError("C√≥digo inv√°lido o clase terminada");
                }, { onlyOnce: true });
            };
            return (
                <div className="min-h-screen bg-gradient-to-b from-blue-600 to-indigo-800 flex items-center justify-center p-4 animate-in">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center">
                        <div className="mb-6 inline-block p-3 bg-blue-50 rounded-full text-blue-600"><Icons.User size={40}/></div>
                        <h1 className="text-3xl font-black text-gray-800 mb-2">Unirse a Clase</h1>
                        <div className="space-y-4 mt-6">
                            <input className="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-xl text-center text-xl uppercase font-bold tracking-widest focus:border-blue-500 outline-none transition" placeholder="C√ìDIGO" value={code} onChange={e=>setCode(e.target.value.toUpperCase())} />
                            <input className="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-xl text-center font-bold text-lg focus:border-blue-500 outline-none transition" placeholder="Tu Nombre" value={name} onChange={e=>setName(e.target.value)} />
                        </div>
                        {error && <div className="mt-4 p-3 bg-red-50 text-red-500 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shake"><Icons.X size={16}/> {error}</div>}
                        <button onClick={handleJoin} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-700 hover:scale-[1.02] transform transition mt-8">¬°Comenzar!</button>
                    </div>
                </div>
            );
        };

        const StudentResults = ({ score, total, history, onHome }) => {
            useEffect(() => {
                playSound('win');
                var duration = 3 * 1000; var animationEnd = Date.now() + duration; var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
                var random = (min, max) => Math.random() * (max - min) + min;
                var interval = setInterval(function() {
                    var timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) return clearInterval(interval);
                    var particleCount = 50 * (timeLeft / duration);
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
                }, 250);
            }, []);
            return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4 text-white animate-in">
                    <div className="max-w-2xl w-full pop-in">
                        <div className="text-center mb-8"><div className="text-6xl mb-4 animate-bounce">üéâ</div><h1 className="text-4xl font-black mb-2 text-yellow-400">¬°Examen Finalizado!</h1><p className="text-slate-400">Has completado todas las preguntas.</p></div>
                        <div className="bg-slate-800 rounded-3xl p-8 border border-slate-700 shadow-2xl mb-8 flex flex-col md:flex-row items-center justify-between gap-8">
                            <div className="text-center md:text-left"><p className="text-sm text-slate-400 uppercase tracking-widest mb-1">Tu Resultado</p><div className="flex items-baseline gap-2 justify-center md:justify-start"><span className="text-6xl font-black text-green-400">{score}</span><span className="text-2xl text-slate-500">/ {total} pts</span></div></div>
                            <div className="flex-1 w-full bg-slate-700 rounded-xl p-4 max-h-64 overflow-y-auto"><h4 className="text-sm font-bold text-slate-300 mb-3 border-b border-slate-600 pb-2">Resumen de Respuestas</h4>{history.map((h, i) => (<div key={i} className="flex justify-between items-center mb-2 text-sm"><div className="flex items-center gap-2 overflow-hidden"><span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${h.isCorrect ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`}>{h.isCorrect ? <Icons.Check size={14}/> : <Icons.X size={14}/>}</span><span className="truncate text-slate-300 max-w-[150px]">{h.q}</span></div><span className={`font-bold ${h.isCorrect ? 'text-green-400' : 'text-red-400'}`}>{h.pts} pts</span></div>))}</div>
                        </div>
                        <button onClick={onHome} className="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-2"><Icons.Home /> Volver al Inicio</button>
                    </div>
                </div>
            );
        };

        const QuizTaker = ({ quiz, onSubmit }) => {
            const [idx, setIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [history, setHistory] = useState([]);
            const [showFeedback, setShowFeedback] = useState(false);
            const [lastIsCorrect, setLastIsCorrect] = useState(false);
            const q = quiz.questions[idx];

            const handleAns = (i) => {
                const isCorrect = i === q.correct;
                const pts = isCorrect ? parseInt(q.points) : 0;
                playSound(isCorrect ? 'correct' : 'wrong');
                setLastIsCorrect(isCorrect);
                setShowFeedback(true);
                setTimeout(() => {
                    const newScore = score + pts;
                    const newHistory = [...history, { q: q.text || "(Imagen)", isCorrect, pts }];
                    setHistory(newHistory);
                    setScore(newScore);
                    setShowFeedback(false);
                    if(idx + 1 < quiz.questions.length) setIdx(idx + 1); else onSubmit(newScore, newHistory);
                }, 1500);
            };

            if (showFeedback) {
                return (
                    <div className="min-h-screen bg-slate-900/90 flex items-center justify-center p-4 fixed inset-0 z-50">
                        <div className={`pop-in text-center p-10 rounded-3xl shadow-2xl border-4 ${lastIsCorrect ? 'bg-white border-green-500' : 'bg-white border-red-500'}`}>
                            <div className="text-8xl mb-4">{lastIsCorrect ? 'ü§©' : 'üò¢'}</div>
                            <h2 className={`text-4xl font-black mb-2 ${lastIsCorrect ? 'text-green-600' : 'text-red-600'}`}>{lastIsCorrect ? '¬°Excelente!' : '¬°Ups, fallaste!'}</h2>
                            <p className="text-gray-500 font-bold text-lg">{lastIsCorrect ? `+${q.points} Puntos` : '0 Puntos'}</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 animate-in">
                    <div className="max-w-3xl w-full bg-white p-8 rounded-3xl shadow-2xl">
                        <div className="flex justify-between mb-6 font-bold text-gray-400 text-sm uppercase tracking-widest"><span>Pregunta {idx+1} de {quiz.questions.length}</span></div>
                        <div className="h-3 bg-gray-100 mb-8 rounded-full overflow-hidden"><div className="h-full bg-blue-500 transition-all duration-500 ease-out" style={{width: `${((idx+1)/quiz.questions.length)*100}%`}}></div></div>
                        <div className="mb-8">
                            {q.imageUrl && <img src={q.imageUrl} className="max-h-60 w-full object-contain mb-6 rounded-2xl border bg-gray-50"/>}
                            <h2 className="text-3xl font-bold text-gray-800 mb-2 math-preview">{renderMathText(q.text)}</h2>
                            <span className="inline-block bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold uppercase mt-2">Valor: {q.points} puntos</span>
                        </div>
                        <div className="grid gap-4">
                            {q.options.map((o, i) => (
                                <button key={i} onClick={()=>handleAns(i)} className="text-left p-5 border-2 border-gray-100 rounded-2xl hover:bg-indigo-50 hover:border-indigo-500 hover:shadow-lg transition group flex items-center gap-4 transform active:scale-95">
                                    <span className="w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center font-black text-lg group-hover:bg-indigo-500 group-hover:text-white transition">{String.fromCharCode(65+i)}</span>
                                    <div className="flex-1 font-medium text-lg text-gray-700">{q.optionImages && q.optionImages[i] && <img src={q.optionImages[i]} className="h-32 rounded-lg mb-3 border object-cover"/>}{o}</div>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const cloud = useCloud();
            const [view, setView] = useState('home');
            const [quizzes, setQuizzes] = useState([]);
            const [activeQuizData, setActiveQuizData] = useState(null);
            const [liveCode, setLiveCode] = useState('');
            const [studentName, setStudentName] = useState('');
            const [studentQuiz, setStudentQuiz] = useState(null);
            const [finalResults, setFinalResults] = useState(null);
            
            useEffect(() => { if (cloud.status === 'ready') window.fbOnValue(window.fbRef(window.db, 'quizzes'), (s) => setQuizzes(s.val() ? Object.values(s.val()) : [])); }, [cloud.status]);

            if (cloud.status === 'loading') return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;

            if (view === 'home') return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 flex flex-col items-center justify-center p-4 text-white animate-in">
                    <div className="text-center mb-12"><h1 className="text-6xl font-black mb-4 tracking-tight">MathMaster <span className="text-yellow-400">Pro</span></h1><p className="text-indigo-200 text-xl">Plataforma de Evaluaci√≥n Interactiva</p></div>
                    <div className="grid gap-6 w-full max-w-lg">
                        <button onClick={()=>{playSound('click'); setView('lobby')}} className="bg-white text-indigo-900 p-6 rounded-2xl font-bold text-2xl shadow-xl hover:scale-105 transition flex items-center justify-center gap-4 group"><div className="bg-indigo-100 p-2 rounded-full group-hover:bg-indigo-200 transition"><Icons.User size={32}/></div> Soy Estudiante</button>
                        <button onClick={()=>{playSound('click'); setView('tutor')}} className="bg-indigo-900/50 backdrop-blur-sm border-2 border-indigo-400 text-white p-6 rounded-2xl font-bold text-2xl shadow-xl hover:bg-indigo-900 transition flex items-center justify-center gap-4">Soy Profesor</button>
                    </div>
                    <div className="absolute bottom-4 text-indigo-300 text-sm opacity-70">Creado y Dise√±ado por <span className="font-bold text-white">Efrain</span></div>
                </div>
            );

            if (view === 'tutor') return (
                <div className="min-h-screen bg-gray-50 p-6 animate-in">
                    <div className="max-w-5xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <button onClick={()=>setView('home')} className="text-gray-500 font-bold hover:text-indigo-600 transition flex items-center gap-2"><Icons.ToggleL className="rotate-180"/> Volver</button>
                            <button onClick={()=>{setActiveQuizData({id:Date.now(), title:'', questions:[]}); setView('editor')}} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center gap-2">+ Nuevo Examen</button>
                        </div>
                        <h2 className="text-3xl font-bold text-gray-800 mb-6">Mis Ex√°menes</h2>
                        <div className="grid md:grid-cols-2 gap-6">
                            {quizzes.map(q => (
                                <div key={q.id} className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition flex flex-col justify-between min-h-[180px]">
                                    <div><h3 className="font-bold text-2xl text-gray-800 mb-1">{q.title}</h3><p className="text-gray-500 font-medium">{(q.questions||[]).length} preguntas</p></div>
                                    <div className="flex gap-3 mt-6">
                                        <button onClick={()=>{const code = Math.random().toString(36).substring(2, 7).toUpperCase(); cloud.activateSession(code, q.id); setActiveQuizData(q); setLiveCode(code); setView('live');}} className="flex-1 bg-green-500 text-white px-4 py-3 rounded-xl font-bold hover:bg-green-600 flex items-center justify-center gap-2 shadow-sm transition"><Icons.Wifi /> LANZAR</button>
                                        <button onClick={()=>{setActiveQuizData(q); setView('editor')}} className="bg-gray-100 text-blue-600 p-3 rounded-xl hover:bg-blue-50 border border-gray-200" title="Editar"><Icons.Edit/></button>
                                        <button onClick={()=>{if(confirm('¬øBorrar?')) cloud.deleteQuiz(q.id)}} className="bg-red-50 text-red-500 p-3 rounded-xl hover:bg-red-100 border border-red-100" title="Borrar"><Icons.Trash/></button>
                                    </div>
                                </div>
                            ))}
                            {quizzes.length === 0 && <div className="col-span-2 border-3 border-dashed border-gray-200 rounded-3xl p-12 text-center text-gray-400"><p className="text-xl">No has creado ex√°menes.</p></div>}
                        </div>
                    </div>
                </div>
            );

            if (view === 'editor') return <Editor quiz={activeQuizData} onSave={(q)=>{cloud.saveQuiz(q); setView('tutor');}} onCancel={()=>setView('tutor')} />;
            if (view === 'live') return <LiveDashboard sessionCode={liveCode} quiz={activeQuizData} onExit={()=>setView('tutor')} />;
            if (view === 'lobby') return <StudentLobby onJoin={(c, n, qId) => { setLiveCode(c); setStudentName(n); window.fbOnValue(window.fbRef(window.db, `quizzes/${qId}`), s=>{setStudentQuiz(s.val()); setView('quiz')}, {onlyOnce:true}); }} />;
            if (view === 'student-results') return <StudentResults score={finalResults.score} total={finalResults.total} history={finalResults.history} onHome={()=>setView('home')} />;
            if (view === 'quiz') return <QuizTaker quiz={studentQuiz} onSubmit={(sc, hist)=>{const total = studentQuiz.questions.reduce((a,b)=>a+(parseInt(b.points)||0),0); cloud.submitScore(liveCode, studentName, sc, total); setFinalResults({ score: sc, total, history: hist }); setView('student-results');}} />;
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
```
